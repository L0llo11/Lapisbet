<!DOCTYPE html>
<html lang="it">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Lapis 25/26 AI</title>
    <style>
        body { font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; background-color: #121212; color: #e0e0e0; margin: 0; padding: 20px; display: flex; justify-content: center; }
        .container { width: 100%; max-width: 800px; background-color: #1e1e1e; padding: 20px; border-radius: 10px; box-shadow: 0 4px 15px rgba(0,0,0,0.5); }
        h1 { color: #060399; text-align: center; margin-bottom: 20px; text-transform: uppercase; letter-spacing: 2px; }
        
        .input-group { margin-bottom: 20px; }
        textarea { width: 100%; height: 100px; background-color: #2c2c2c; border: 1px solid #444; color: #fff; padding: 10px; border-radius: 5px; font-size: 16px; box-sizing: border-box; resize: none; }
        textarea:focus { outline: none; border-color: #060399; }
        
        /* Pulsante Principale */
        button#sendBtn { width: 100%; padding: 15px; background-color: #060399; color: #fff; border: none; border-radius: 5px; font-size: 18px; font-weight: bold; cursor: pointer; transition: background 0.3s; margin-top: 10px; }
        button#sendBtn:hover { background-color: #0000cc; }
        button:disabled { background-color: #555; cursor: not-allowed; }

        /* Pulsante Mostra/Nascondi Analisi (Stile diverso) */
        button.toggle-btn {
            width: 100%;
            padding: 10px;
            background-color: transparent;
            border: 1px solid #060399;
            color: #060399;
            border-radius: 5px;
            font-size: 14px;
            font-weight: bold;
            cursor: pointer;
            margin-top: 15px;
            display: none; /* Nascosto all'inizio */
        }
        button.toggle-btn:hover { background-color: #060399; color: #fff; }

        #loading { display: none; text-align: center; color: #888; margin: 10px 0; font-style: italic; }
        
        /* Stile per la risposta Markdown */
        #output { background-color: #252525; padding: 20px; border-radius: 5px; border: 1px solid #333; min-height: 50px; line-height: 1.6; }
        #output table { width: 100%; border-collapse: collapse; margin-top: 0; margin-bottom: 0; background-color: #2c2c2c; }
        #output th, #output td { padding: 10px; border: 1px solid #444; text-align: left; }
        #output th { background-color: #04004d; color: #fff; }
        #output tr:nth-child(even) { background-color: #333; }
        #output strong { color: #060399; }

        /* Contenitore Analisi Nascosto */
        #analysisContainer {
            display: none;
            margin-top: 20px;
            padding-top: 20px;
            border-top: 1px dashed #444;
            font-size: 14px;
            color: #ccc;
        }
    </style>
    
    <script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>
    
    <script type="importmap">
      {
        "imports": {
          "@google/generative-ai": "https://esm.run/@google/generative-ai"
        }
      }
    </script>
</head>
<body>

<div class="container">
    <h1>‚öΩ Lapis </h1>
    
    <div class="input-group">
        <textarea id="userInput" placeholder="Es: Luned√¨ 20 Novembre, voglio una quota 5.00 con partite sicure..."></textarea>
        <button id="sendBtn" onclick="generaPronostico()">ANALIZZA PARTITE</button>
    </div>

    <div id="loading">Lapis sta analizzando i dati 2025/2026... ‚è≥</div>
    
    <div id="output">I risultati appariranno qui...</div>
    
    <button id="toggleAnalysisBtn" class="toggle-btn" onclick="toggleAnalysis()">üìñ LEGGI ANALISI DETTAGLIATA</button>
    
    <div id="analysisContainer"></div>
</div>

<script type="module">
    import { GoogleGenerativeAI } from "@google/generative-ai";

    // --- CONFIGURAZIONE ---
    // ‚ö†Ô∏è INSERISCI QUI LA TUA API KEY (Quella di prima va bene)
    const API_KEY = "INSERISCI_QUI_LA_TUA_API_KEY"; 
    
    const SYSTEM_PROMPT = `
    Sei "Lapis", un analista calcistico ossessivo.
    
    üî¥ PROTOCOLLO TEMPORALE:
    1. LA DATA DI OGGI √à LEGGE.
    2. DIVIETO DATI VECCHI: Ignora dati di stagioni passate.
    3. Usa statistiche 2025/2026.

    üî¥ PROTOCOLLO NOMI & ANALISI:
    1. **Sii vago sui nomi se insicuro:** Non citare allenatori o giocatori specifici a meno che tu non sia certo al 100% che siano nella rosa attuale. Usa termini come "l'attacco", "la difesa", "il tecnico".
    2. **Eccezione Marcatori:** Se consigli un marcatore, devi essere ragionevolmente sicuro che giochi ancora l√¨.
    3. **Analisi Breve:** Sii sintetico e diretto.

    FORMATO OUTPUT OBBLIGATORIO (Segui questo ordine esatto):
    1. Prima stampa SOLO la TABELLA RIASSUNTIVA Markdown.
    2. Poi scrivi esattamente la stringa separatrice: "---ANALISI---"
    3. Dopo il separatore, scrivi le analisi brevi partita per partita.

    Struttura Tabella:
    | Orario | Match | Scommessa | Quota |
    | :--- | :--- | :--- | :--- |
    | HH:MM | Squadra A - B | Esito | @Quota |
    | TOTALE | RIEPILOGO | MOLTIPLICATORE | @Totale |
    `;

    const genAI = new GoogleGenerativeAI(API_KEY);
    
    // Corretto il modello in 1.5-flash e rimossi i tools search che bloccano l'HTML
    const model = genAI.getGenerativeModel({ 
        model: "gemini-1.5-flash"
    });

    window.generaPronostico = async function() {
        const inputField = document.getElementById("userInput");
        const outputDiv = document.getElementById("output");
        const analysisDiv = document.getElementById("analysisContainer");
        const toggleBtn = document.getElementById("toggleAnalysisBtn");
        const loadingDiv = document.getElementById("loading");
        const btn = document.getElementById("sendBtn");
        
        const userPrompt = inputField.value.trim();
        if (!userPrompt) return alert("Scrivi qualcosa!");

        // Reset UI
        btn.disabled = true;
        loadingDiv.style.display = "block";
        outputDiv.innerHTML = "";
        analysisDiv.innerHTML = "";
        analysisDiv.style.display = "none";
        toggleBtn.style.display = "none";

        try {
            const today = new Date().toLocaleDateString('it-IT', { weekday: 'long', year: 'numeric', month: 'long', day: 'numeric' });
            
            // Uniamo prompt di sistema e utente per massima compatibilit√†
            const finalPrompt = `${SYSTEM_PROMPT}\n\n(OGGI √à: ${today}).\nRICHIESTA UTENTE: ${userPrompt}`;

            const result = await model.generateContent(finalPrompt);
            const response = await result.response;
            const text = response.text();

            // --- LOGICA DI SEPARAZIONE TABELLA / ANALISI ---
            const parts = text.split("---ANALISI---");
            
            const tabella = parts[0]; 
            const analisi = parts.length > 1 ? parts[1] : "Nessuna analisi dettagliata disponibile.";

            // Mostra subito la tabella
            outputDiv.innerHTML = marked.parse(tabella);

            // Prepara l'analisi ma tienila nascosta
            if (parts.length > 1) {
                analysisDiv.innerHTML = marked.parse(analisi);
                toggleBtn.style.display = "block"; // Mostra il pulsante per aprire
            }

        } catch (error) {
            console.error(error);
            outputDiv.innerHTML = `<span style="color:red">Errore: ${error.message}</span>`;
        } finally {
            loadingDiv.style.display = "none";
            btn.disabled = false;
        }
    }

    // Funzione per il pulsante Mostra/Nascondi
    window.toggleAnalysis = function() {
        const div = document.getElementById("analysisContainer");
        const btn = document.getElementById("toggleAnalysisBtn");
        
        if (div.style.display === "none") {
            div.style.display = "block";
            btn.innerText = "‚úñ CHIUDI ANALISI";
        } else {
            div.style.display = "none";
            btn.innerText = "üìñ LEGGI ANALISI DETTAGLIATA";
        }
    }
</script>

</body>
</html>
